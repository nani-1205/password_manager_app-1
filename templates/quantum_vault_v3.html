{% extends "logged_in_base_v3.html" %} {# <-- Use the correct logged-in base template #}

{% block title %}Vault Dashboard{% endblock %}

{% block main_content %} {# Content goes into the main_content block defined in logged_in_base_v3.html #}
    <div class="content"> {# This div provides padding and scroll defined in quantum-v3.css #}

        {# --- Add Entry Form Section (Initially Hidden) --- #}
        <div id="add-entry-section" class="add-entry-form-container hidden"> {# Use hidden class, toggled by sidebar JS #}
             <h3><i class="bi bi-plus-circle me-2"></i>Add New Vault Entry</h3>
             <form method="POST" action="{{ url_for('add_entry') }}" id="add-entry-form">
                <div class="form-group"> <label for="add_laptop_server" class="form-label">Laptop/Server ID:</label> <input type="text" class="form-input" id="add_laptop_server" name="laptop_server" required> </div>
                <div class="form-group"> <label for="add_brand_label" class="form-label">Brand/Label <span class="text-muted">(Optional)</span>:</label> <input type="text" class="form-input" id="add_brand_label" name="brand_label"> </div>
                <div class="form-group"> <label for="add_entry_username" class="form-label">Username:</label> <input type="text" class="form-input" id="add_entry_username" name="entry_username" required> </div>
                <div class="form-group"> <label for="add_entry_password" class="form-label">Password:</label> <div class="input-group"> <input type="password" class="form-input" id="add_entry_password" name="entry_password" required autocomplete="new-password"> <button class="btn btn-outline" type="button" id="generate-add-btn" title="Generate Password"><i class="bi bi-stars"></i></button> <button class="btn btn-outline" type="button" id="show-hide-add-btn" data-target="add_entry_password" title="Show Password"><i class="bi bi-eye-fill"></i></button> </div> </div>
                <div class="form-buttons d-flex justify-content-end gap-2 mt-3"> <button type="button" class="btn btn-outline" id="cancel-add-entry"><i class="bi bi-x-lg"></i> Cancel</button> <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> Save Entry</button> </div>
            </form>
        </div>
        {# --- END Add Entry Section --- #}


        {# Stored Entries Section Title #}
        <h2 class="section-title mt-4">
            Stored Entries {% if search_term %}<span style="font-size: 0.8em; color: var(--text-secondary);">(Filtered)</span>{% endif %}
        </h2>

        {# Grid/List Container for Vault Entries #}
        {# Use entries-grid for card layout or entry-list for list layout based on CSS #}
        <div class="entry-list"> {# Using entry-list class as per provided HTML/CSS #}
            {% if entries %} {# Check if there are any entries to display #}
                {% for entry in entries %} {# Loop through each entry #}
                <div class="password-entry"> {# Entry Row/Card #}
                    {# Icon #}
                    <div class="entry-icon {% if session.get('role') == 'admin' and entry.user_id|string != session.get('user_id') %}admin{% endif %}">
                        {{ (entry.brand_label or entry.laptop_server or '?')[0]|upper }}
                    </div>

                    {# Main details section #}
                    <div class="entry-details">
                        <div class="entry-title">
                            {{ entry.laptop_server }} {# Laptop/Server ID #}
                            {% if entry.brand_label %}<span class="entry-brand-tag">{{ entry.brand_label }}</span>{% endif %} {# Brand Tag #}
                            {% if session.get('role') == 'admin' and entry.user_id|string != session.get('user_id') %}<i class="bi bi-person-badge text-warning ms-2" title="Entry belongs to another user"></i>{% endif %} {# Admin Indicator #}
                        </div>
                        {# Use entry-subtitle for username as per provided CSS/HTML #}
                        <div class="entry-subtitle"><i class="bi bi-person me-1"></i> {{ entry.entry_username }}</div> {# Display Username #}

                        {# --- PASSWORD AREA - Including Show/Hide Button --- #}
                        <div class="entry-password-area">
                            <span class="password-mask" id="dots-{{ entry._id | string }}">••••••••••••</span>
                            <span class="password-revealed" id="text-{{ entry._id | string }}" style="display: none;"></span> {# JS populates this when shown #}
                            <button type="button" class="action-btn-icon-only show-stored-btn" data-id="{{ entry._id | string }}" title="Show/Hide Password">
                                 <i class="bi bi-eye-fill"></i> {# Default icon state #}
                             </button>
                        </div>
                        {# --- END PASSWORD AREA --- #}
                    </div>

                    {# --- ACTION BUTTONS --- #}
                    <div class="entry-actions">
                         {# Edit Button (triggers modal) #}
                         <button type="button" class="action-btn-icon-only edit-btn" data-id="{{ entry._id | string }}" data-bs-toggle="modal" data-bs-target="#entryModal" title="Edit Entry">
                             <i class="bi bi-pencil-fill"></i>
                         </button>
                         {# Copy Button #}
                         <button type="button" class="action-btn-icon-only copy-btn" data-id="{{ entry._id | string }}" title="Copy Password">
                             <i class="bi bi-clipboard-fill"></i>
                         </button>
                         {# Delete Button (in a form) #}
                         <form method="POST" action="{{ url_for('delete_entry', entry_id=entry._id) }}" class="d-inline">
                             <button type="submit" class="action-btn-icon-only delete-btn" onclick="return confirm('Delete entry for \'{{ entry.laptop_server }}\'?');" title="Delete Entry">
                                 <i class="bi bi-trash-fill"></i>
                             </button>
                         </form>
                    </div>
                     {# --- END ACTION BUTTONS --- #}
                </div> {# End password-entry #}
                {% endfor %} {# End of loop #}
            {% else %} {# If no entries exist (or match search) #}
                 <div class="alert alert-info mt-3" style="grid-column: 1 / -1;"> {# Adjust if not using grid #}
                     {% if search_term %}
                        No entries found matching your search criteria. <a href="{{ url_for('vault') }}" class="alert-link">Clear Search</a>
                     {% else %}
                        Your vault is empty. Click "Add Entry" in the sidebar to add items.
                     {% endif %}
                 </div>
            {% endif %} {# End check for entries #}
        </div> {# End entry-list #}

        {# Include the Add/Edit Modal Partial (Contains the hidden Edit form structure) #}
        {% include 'partials/_add_edit_modal.html' %}

    </div> {# End content #}
{% endblock %} {# End main_content block #}

{% block scripts %}
    {# Link the JavaScript specific to this vault layout #}
    <script src="{{ url_for('static', filename='js/vault-v3.js') }}"></script>
    {# Inline script for Add Entry Cancel button (Can be moved to vault-v3.js if preferred) #}
    <script>
        // Cancel Button Logic for Add Entry Form
        const cancelBtn = document.getElementById('cancel-add-entry');
        const addSection = document.getElementById('add-entry-section');
        const addSidebarBtn = document.getElementById('add-entry-sidebar-btn');
        if (cancelBtn && addSection && addSidebarBtn) {
            cancelBtn.addEventListener('click', function() {
                addSection.classList.add('hidden'); // Hide the form
                addSidebarBtn.classList.remove('active'); // Deactivate sidebar button
                const form = addSection.querySelector('form');
                if(form) form.reset(); // Reset form fields
            });
        }
        // All other button JS (Generate, Show/Hide, Edit Modal Trigger, Card buttons) handled by vault-v3.js
    </script>
{% endblock %}