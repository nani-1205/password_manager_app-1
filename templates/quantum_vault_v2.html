{% extends "logged_in_base_v2.html" %}

{% block title %}Vault Dashboard{% endblock %}

{% block main_content %}
    <div class="content">
        {# Add Entry Form Section (Initially Hidden) - Remains the same #}
        <div id="add-entry-section" class="add-entry-form-container hidden">
             <h3><i class="bi bi-plus-circle me-2"></i>Add New Vault Entry</h3>
             <form method="POST" action="{{ url_for('add_entry') }}" id="add-entry-form">
                 {# ... Fields: laptop_server, brand_label, entry_username ... #}
                <div class="form-group"> <label for="laptop_server" class="form-label">Laptop/Server ID:</label> <input type="text" class="form-input" id="laptop_server" name="laptop_server" required> </div>
                <div class="form-group"> <label for="brand_label" class="form-label">Brand/Label <span class="text-muted">(Optional)</span>:</label> <input type="text" class="form-input" id="brand_label" name="brand_label"> </div>
                <div class="form-group"> <label for="entry_username" class="form-label">Username:</label> <input type="text" class="form-input" id="entry_username" name="entry_username" required> </div>
                <div class="form-group">
                    <label for="entry_password" class="form-label">Password:</label>
                    <div class="input-group">
                         <input type="password" class="form-input" id="entry_password" name="entry_password" required autocomplete="new-password">
                         <button class="btn btn-outline" type="button" id="generate-btn" title="Generate Password"><i class="bi bi-stars"></i></button>
                         <button class="btn btn-outline" type="button" id="show-hide-btn" data-target="entry_password" title="Show Password"><i class="bi bi-eye-fill"></i></button>
                    </div>
                </div>
                <div class="form-buttons d-flex justify-content-end gap-2 mt-3">
                     <button type="button" class="btn btn-outline" id="cancel-add-entry"><i class="bi bi-x-lg"></i> Cancel</button>
                     <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> Save Entry</button>
                </div>
            </form>
        </div>

        {# Stored Entries Section #}
        <h2 class="section-title mt-4"> Stored Entries {% if search_term %}<span style="font-size: 0.8em; color: var(--text-secondary);">(Filtered)</span>{% endif %} </h2>
        <div class="entries-grid">
            {% if entries %}
                {% for entry in entries %}
                <div class="entry-card">
                    <div class="entry-icon"> {{ (entry.brand_label or entry.laptop_server or '?')[0]|upper }} </div>
                    <div class="entry-details">
                        <div class="entry-title">{{ entry.laptop_server }}</div>
                        {% if entry.brand_label %}<div class="entry-brand">{{ entry.brand_label }}</div>{% endif %}
                        <div class="entry-credential"><i class="bi bi-person"></i> {{ entry.entry_username }}</div>
                        <div class="entry-password-area">
                            <span class="password-mask" id="dots-{{ entry._id | string }}">••••••••••••</span>
                            <span class="password-revealed" id="text-{{ entry._id | string }}" style="display: none;"></span>
                            <button type="button" class="action-btn-icon-only show-stored-btn" data-id="{{ entry._id | string }}" title="Show/Hide Password"> <i class="bi bi-eye-fill"></i> </button>
                        </div>
                    </div>
                    <div class="entry-actions">
                        {# --- UPDATED EDIT BUTTON to trigger modal --- #}
                        <button type="button" class="action-btn-icon-only edit-btn" data-id="{{ entry._id | string }}" data-bs-toggle="modal" data-bs-target="#editEntryModal" title="Edit Entry"><i class="bi bi-pencil-fill"></i></button>
                        {# --- END EDIT BUTTON --- #}
                        <button type="button" class="action-btn-icon-only copy-btn" data-id="{{ entry._id | string }}" title="Copy Password"><i class="bi bi-clipboard-fill"></i></button>
                        <form method="POST" action="{{ url_for('delete_entry', entry_id=entry._id) }}" class="d-inline">
                             <button type="submit" class="action-btn-icon-only delete-btn" onclick="return confirm('Delete entry for \'{{ entry.laptop_server }}\'?');" title="Delete Entry"><i class="bi bi-trash-fill"></i></button>
                         </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                 <div class="alert alert-info mt-3" style="grid-column: 1 / -1;">
                     {% if search_term %} No entries found matching search. <a href="{{ url_for('vault') }}" class="alert-link">Clear</a>
                     {% else %} Vault is empty. Click "Add Entry" in the sidebar. {% endif %}
                 </div>
            {% endif %}
        </div> {# End entries-grid #}
    </div> {# End content #}

    {# --- NEW: Edit Entry Modal --- #}
    <div class="modal fade" id="editEntryModal" tabindex="-1" aria-labelledby="editEntryModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"> {# Uses Bootstrap modal styling adapted by quantum-v2.css #}
                {# Form action will be set dynamically by JavaScript #}
                <form method="POST" action="" id="edit-entry-modal-form">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editEntryModalLabel">Edit Vault Entry</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                         {# Hidden field to store entry ID #}
                         <input type="hidden" id="edit_entry_id" name="entry_id_from_hidden_field"> {# Name doesn't matter much if action is dynamic #}

                         <div class="form-group">
                            <label for="edit_laptop_server" class="form-label">Laptop/Server ID:</label>
                            <input type="text" class="form-input" id="edit_laptop_server" name="laptop_server" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_brand_label" class="form-label">Brand/Label <span class="text-muted">(Optional)</span>:</label>
                            <input type="text" class="form-input" id="edit_brand_label" name="brand_label">
                        </div>
                        <div class="form-group">
                            <label for="edit_entry_username" class="form-label">Username:</label>
                            <input type="text" class="form-input" id="edit_entry_username" name="entry_username" required>
                        </div>
                         <div class="form-group">
                            <label for="edit_entry_password" class="form-label">Password:</label>
                            <div class="input-group">
                                 <input type="password" class="form-input" id="edit_entry_password" name="password" placeholder="Leave blank to keep current" autocomplete="new-password">
                                 <button class="btn btn-outline" type="button" id="generate-edit-modal-btn" title="Generate New Password"><i class="bi bi-stars"></i></button>
                                 <button class="btn btn-outline" type="button" id="show-hide-edit-modal-btn" data-target="edit_entry_password" title="Show Password"><i class="bi bi-eye-fill"></i></button>
                            </div>
                             <div class="form-text text-secondary mt-1" style="font-size: 0.85em;">
                                Leave blank to keep the current password.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Entry</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
     {# --- END Edit Entry Modal --- #}

{% endblock %} {# End main_content block #}

{% block scripts %}
    {# Link the JavaScript specific to this vault layout #}
    <script src="{{ url_for('static', filename='js/vault-v2.js') }}"></script>
    {# Add JS for the Add Entry Cancel button #}
    <script>
        const cancelBtn = document.getElementById('cancel-add-entry');
        const addSection = document.getElementById('add-entry-section');
        const addSidebarBtn = document.getElementById('add-entry-sidebar-btn');
        if (cancelBtn && addSection && addSidebarBtn) {
            cancelBtn.addEventListener('click', function() {
                addSection.classList.add('hidden'); addSidebarBtn.classList.remove('active');
                const form = addSection.querySelector('form'); if(form) form.reset();
            });
        }
        // Show/Hide Add Form Password
        const showHideBtnAddForm = document.querySelector('#add-entry-form #show-hide-btn');
        if (showHideBtnAddForm) {
             showHideBtnAddForm.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                const icon = this.querySelector('i');
                if(passwordInput && icon) {
                    if (passwordInput.type === 'password') { icon.className = 'bi bi-eye-slash-fill'; this.title = 'Hide Password'; }
                    else { icon.className = 'bi bi-eye-fill'; this.title = 'Show Password'; }
                    passwordInput.type = (passwordInput.type === 'password' ? 'text' : 'password');
                 }
             });
         }
         // Add JS for Edit Modal Buttons (Generate/Show)
         const showHideEditModalBtn = document.getElementById('show-hide-edit-modal-btn');
         if (showHideEditModalBtn) {
              showHideEditModalBtn.addEventListener('click', function() {
                 const targetId = this.getAttribute('data-target'); // edit_entry_password
                 const passwordInput = document.getElementById(targetId);
                 const icon = this.querySelector('i');
                 if(passwordInput && icon) {
                     if (passwordInput.type === 'password') { icon.className = 'bi bi-eye-slash-fill'; this.title = 'Hide Password'; }
                     else { icon.className = 'bi bi-eye-fill'; this.title = 'Show Password'; }
                     passwordInput.type = (passwordInput.type === 'password' ? 'text' : 'password');
                  }
              });
         }
         const generateEditModalBtn = document.getElementById('generate-edit-modal-btn');
         const passwordEditModalField = document.getElementById('edit_entry_password');
         if (generateEditModalBtn && passwordEditModalField) {
              generateEditModalBtn.addEventListener('click', async function() {
                 this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>'; this.disabled = true;
                 try {
                     const data = await fetchApi('/generate_password'); passwordEditModalField.value = data.password;
                     passwordEditModalField.type = 'text';
                     if(showHideEditModalBtn) { const icon = showHideEditModalBtn.querySelector('i'); if(icon) icon.className = 'bi bi-eye-slash-fill'; showHideEditModalBtn.title = 'Hide Password'; }
                 } catch (error) { alert('Error generating password: ' + error.message); }
                 finally { this.innerHTML = '<i class="bi bi-stars"></i>'; this.disabled = false; }
             });
         }

    </script>
{% endblock %}