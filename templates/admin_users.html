{% extends "logged_in_base_v4.html" %} {# Use new base #}

{% block title %}User Management{% endblock %}

{% block page_title %}User Management{% endblock %} {# Sets title in header #}

{% block header_actions %}
    {# Search bar specific to this page #}
     <div class="search-bar">
        <input class="search-input" type="search" id="user-search-input" placeholder="Search users...">
        <div class="search-icon"><i class="bi bi-search"></i></div>
    </div>
    {# Add User Button (could trigger a modal later) #}
    {# <button class="btn btn-primary"><i class="bi bi-person-plus-fill"></i> Add User</button> #}
{% endblock %}


{% block content %}
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">User List</h2>
        {# Add filtering controls here if needed #}
      </div>

      <table class="table" id="user-table">
        <thead>
          <tr>
            <th>Username</th>
            <th class="role-cell">Role</th>
            <th class="status-cell">Status</th>
            <th class="two-fa-cell">2FA</th>
            {# <th class="hide-mobile">Last Login</th> #}
            <th class="actions-cell">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            {# Username & Identifying self #}
            <td>
                {{ user.username }}
                {% if user._id | string == session.get('user_id') %}
                    <span class="badge rounded-pill text-bg-secondary ms-2" style="font-size: 0.7em;">You</span>
                {% endif %}
            </td>
            {# Role & Form #}
            <td class="role-cell">
              <form method="POST" action="{{ url_for('admin_change_user_role', user_id=user._id) }}" class="d-inline-flex align-items-center">
                    {# Use custom styled badge-like select or keep simple form select #}
                    <select name="role" class="form-input form-select-sm d-inline-block w-auto me-1 py-1 px-2" style="font-size: 0.8rem;" {% if user._id | string == session.get('user_id') %}disabled title="Cannot change own role"{% endif %}>
                        <option value="user" {% if user.get('role', 'user') == 'user' %}selected{% endif %}>User</option>
                        <option value="admin" {% if user.get('role') == 'admin' %}selected{% endif %}>Admin</option>
                    </select>
                    {# Use action-btn style for consistency #}
                    <button type="submit" class="btn action-btn edit btn-sm" style="padding: 0.3rem 0.5rem;" {% if user._id | string == session.get('user_id') %}disabled{% endif %} title="Save Role"><i class="bi bi-save"></i></button>
                </form>
            </td>
             {# Status & Form #}
            <td class="status-cell">
                 <form method="POST" action="{{ url_for('admin_toggle_user_status', user_id=user._id) }}" class="d-inline">
                     {% if user.get('is_active', True) %}
                         <button type="submit" class="badge badge-success" style="border: none; cursor: pointer;" {% if user._id | string == session.get('user_id') %}disabled title="Cannot disable self"{% endif %}>Active</button>
                     {% else %}
                         <button type="submit" class="badge badge-danger" style="background-color: #fee2e2; color: #991b1b; border: none; cursor: pointer;">Disabled</button>
                     {% endif %}
                 </form>
            </td>
            {# 2FA Status Badge #}
            <td class="two-fa-cell">
                 {% if user.get('is_2fa_enabled') %}
                     <span class="badge badge-primary">Enabled</span> {# Use primary color #}
                 {% else %}
                     <span class="badge badge-secondary">Disabled</span>
                 {% endif %}
            </td>
            {# Last Login (Optional) #}
            {# <td class="hide-mobile">Apr 9, 2025 - 09:45</td> #}
            {# Actions #}
            <td class="actions-cell">
              <div class="table-actions">
                    <a href="{{ url_for('admin_view_user_vault', user_id=user._id) }}" class="btn action-btn view btn-sm" title="View User's Vault (Metadata)"><i class="bi bi-eye"></i></a>
                    <form method="POST" action="{{ url_for('admin_delete_user', user_id=user._id) }}" class="d-inline">
                        <button type="submit" class="btn action-btn delete btn-sm" {% if user._id | string == session.get('user_id') %}disabled title="Cannot delete self"{% endif %} onclick="return confirm('DELETE user \'{{ user.username }}\' and ALL their vault entries? This cannot be undone!');"><i class="bi bi-trash"></i></button>
                    </form>
              </div>
            </td>
          </tr>
          {% else %}
            <tr><td colspan="5" class="text-center text-muted py-4">No other users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
{% endblock %}

{% block scripts %}
{# Optional JS for client-side search/filtering of the user table #}
<script>
    const searchInput = document.getElementById('user-search-input');
    const userTable = document.getElementById('user-table');
    if (searchInput && userTable) {
        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();
            const rows = userTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                // Search multiple cells (e.g., username, role)
                const usernameText = (row.cells[0].textContent || row.cells[0].innerText).toLowerCase();
                const roleText = (row.cells[1].querySelector('select') ? row.cells[1].querySelector('select option:checked').text : '').toLowerCase(); // Get selected role text
                if (usernameText.indexOf(filter) > -1 || roleText.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    }
</script>
{% endblock %}